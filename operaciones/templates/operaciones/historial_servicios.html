{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Servicios - {{ asegurado.nombre_completo }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

    <form id="logout-form" method="post" action="{% url 'logout' %}">{% csrf_token %}</form>

    <header class="bg-[#008CBA] shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <img src="{% static 'img/LOGO_CIMECI_RIF.JPG' %}" alt="Logo CIMECI" style="height: 120px;" class="mr-4">
                <h1 class="text-2xl font-bold text-white">Portal de Operaciones</h1>
            </div>
            <div class="text-white">
                Bienvenido, {{ user.username }} | 
                <a href="#" onclick="document.getElementById('logout-form').submit();" class="hover:underline">Cerrar Sesión</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-7xl mx-auto">
            
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Consulta de Servicios</h2>
                <a href="{% url 'validar_asegurabilidad' %}?q={{ asegurado.cedula }}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">
                    &larr; Volver a la Validación
                </a>
            </div>

            <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
                <h3 class="text-xl font-semibold text-gray-700">{{ asegurado.nombre_completo }}</h3>
                <p class="text-gray-600">Contrato: <span class="font-bold">{{ contrato.numero_contrato }}</span> | Vigencia: <span class="font-bold">{{ contrato.fecha_inicio_vigencia|date:"d/m/Y" }} al {{ contrato.fecha_fin_vigencia|date:"d/m/Y" }}</span></p>
            </div>
            
            <!-- Botones de Acción -->
            <div class="my-6 flex flex-wrap gap-4 justify-center">
                <a href="{% url 'crear_orden_de_servicio' asegurado_id=asegurado.id %}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg">
                    Cargar Servicio
                </a>
                <a href="#" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg">
                    Servicio Improcedente
                </a>
            </div>

            <!-- Resumen de Coberturas -->
            <div class="mb-8">
                <h4 class="font-bold text-lg mb-2 text-gray-700">Resumen de Coberturas del Plan</h4>
                <div class="overflow-x-auto border rounded-md">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-2 px-4 text-left">Categoría de Servicio</th>
                                <th class="py-2 px-4 text-center">Límite Anual</th>
                                <th class="py-2 px-4 text-center">Límite Mensual</th>
                                <th class="py-2 px-4 text-center">Consumido (Anual)</th>
                                <th class="py-2 px-4 text-center">Disponible</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cobertura in coberturas %}
                            <tr class="hover:bg-gray-50 border-t">
                                <td class="py-2 px-4">{{ cobertura.descripcion }}</td>
                                <td class="py-2 px-4 text-center">{{ cobertura.cantidad_maxima }}</td>
                                <td class="py-2 px-4 text-center">{% if cobertura.limite_mensual > 0 %}{{ cobertura.limite_mensual }}{% else %}N/A{% endif %}</td>
                                <td class="py-2 px-4 text-center">{{ cobertura.consumido_anual }}</td>
                                <td class="py-2 px-4 text-center font-bold {% if cobertura.disponible <= 0 %}text-red-600{% else %}text-green-600{% endif %}">{{ cobertura.disponible }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Historial de Servicios Otorgados -->
            <div>
                <h4 class="font-bold text-lg mb-2 text-gray-700">Historial Detallado de Órdenes de Servicio</h4>
                <div class="overflow-x-auto border rounded-md">
                    <table class="min-w-full bg-white text-sm">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-3 px-4 text-left">N° OS</th>
                                <th class="py-3 px-4 text-left">Fecha</th>
                                <th class="py-3 px-4 text-left">Proveedor</th>
                                <th class="py-3 px-4 text-left">Servicios</th>
                                <th class="py-3 px-4 text-center">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for os in ordenes %}
                            <tr class="hover:bg-gray-50">
                                <td class="py-3 px-4 border-b">{{ os.numero_os }}</td>
                                <td class="py-3 px-4 border-b">{{ os.fecha_emision|date:"d/m/Y" }}</td>
                                <td class="py-3 px-4 border-b">{{ os.punto_atencion.proveedor.razon_social }}</td>
                                <td class="py-3 px-4 border-b">
                                    <ul class="list-disc list-inside">
                                        {% for servicio_baremo in os.servicios_prestados.all %}
                                            <li>{{ servicio_baremo.sub_servicio.descripcion }}</li>
                                        {% endfor %}
                                    </ul>
                                </td>
                                <td class="py-3 px-4 border-b text-center">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full 
                                        {% if os.estado_os == 'PAG' %} bg-green-200 text-green-800
                                        {% elif os.estado_os == 'PEN' %} bg-yellow-200 text-yellow-800
                                        {% elif os.estado_os == 'ACT' %} bg-blue-200 text-blue-800
                                        {% elif os.estado_os == 'SUS' %} bg-red-200 text-red-800
                                        {% elif os.estado_os == 'REC' %} bg-red-600 text-white
                                        {% else %} bg-gray-200 text-gray-800 {% endif %}">
                                        {{ os.get_estado_os_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">No se encontraron OS en esta vigencia.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</body>
</html>